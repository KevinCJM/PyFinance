# **投资组合有效前沿与可配置空间计算 API 文档**

## **1. 概述**

### **1.1. 接口目标**

本 API 提供了一套强大的投资组合分析工具，能够根据不同的约束条件，计算并返回投资组合的**可配置空间**（大量满足约束的随机权重组合）与**有效前沿**（在给定风险下收益最优的组合边界）。

该接口设计为模块化，调用方可以通过在请求体中提供不同的参数组合，来触发一种或多种计算任务。

### **1.2. 接口信息**

*   **路径**: `/api/v1/calculate-portfolios` (暂定)
*   **方法**: `POST`
*   **请求头**: `Content-Type: application/json`

---

## **2. 通用响应格式**

### **2.1. 成功响应**

当所有请求的计算都成功完成时，HTTP状态码为 `200 OK`，响应体结构如下：

```json
{
  "success": true,
  "data": {
    "market": { ... },
    "standard": { ... },
    "user": { ... }
  }
}
```

*   `success`: (布尔型) 始终为 `true`。
*   `data`: (对象) 包含所有请求计算模块的结果。键名 (`market`, `standard`, `user`) 取决于请求中提供了哪些参数模块。

### **2.2. 失败响应**

当请求处理过程中发生任何错误时，HTTP状态码可能为 `400` (客户端错误) 或 `500` (服务器内部错误)，响应体结构如下：

```json
{
  "success": false,
  "error_code": "ERROR_CODE_STRING",
  "message": "详细的错误描述信息"
}
```

*   `success`: (布尔型) 始终为 `false`。
*   `error_code`: (字符串) 错误的唯一标识码，便于程序化处理。
*   `message`: (字符串) 对错误的详细文字说明。

---

## **3. 功能模块详解**

### **3.1. 功能一：计算无约束的市场组合**

*   **功能描述**: 计算在最宽松约束（每个资产权重在0到1之间）下的市场组合可配置空间与有效前沿。

*   **请求参数 (`入参`)**: 
    *   `asset_list` (Array[String], **必需**): 定义计算所涉及的资产名称列表。后续所有权重数组的顺序都与此对应。
    *   `cal_market_ef` (Boolean, **必需**): 必须设置为 `true` 来触发此功能的计算。

*   **响应结果 (`出参`)**: 
    *   成功时，响应的 `data` 对象中将包含一个 `market` 键，其值的结构如下：
        *   `weights` (Array[Array[Float]]): 二维数组，代表所有生成的投资组合权重。
        *   `ret_annual` (Array[Float]): 一维数组，包含每个组合对应的**年化收益率**。
        *   `risk_arr` (Array[Float]): 一维数组，包含每个组合对应的**年化风险值**。
        *   `ef_mask` (Array[Boolean]): 一维布尔数组，`true` 表示对应索引的组合位于有效前沿上。

*   **请求示例**:
    ```json
    {
      "asset_list": ["货币现金类", "固定收益类", "权益投资类"],
      "cal_market_ef": true
    }
    ```

*   **响应示例**:
    ```json
    {
        "success": true,
        "data": {
            "market": {
                "weights": [[0.1, 0.2, 0.7], [0.2, 0.3, 0.5], ...],
                "ret_annual": [0.05, 0.06, ...],
                "risk_arr": [0.08, 0.09, ...],
                "ef_mask": [false, true, ...]
            }
        }
    }
    ```

### **3.2. 功能二：计算标准组合 (C1-C6)**

*   **功能描述**: 计算单个或多个标准风险等级（如C1到C6）各自约束下的可配置空间与有效前沿。

*   **请求参数 (`入参`)**: 
    *   `asset_list` (Array[String], **必需**): 资产名称列表。
    *   `WeightRange` (Object, **必需**): 定义**每个标准组合**的大类资产权重上下限。外层Key为组合名称（如"C1"），内层Key为资产名称，Value为 `[最小权重, 最大权重]`。
    *   `StandardProportion` (Object, **必需**): 定义**每个标准组合**的官方标准权重配比。外层Key为组合名称，内层Key为资产名称，Value为权重比例。
    * **请求示例**:
    ```json
    {
      "asset_list": ["货币现金类", "固定收益类", "权益投资类"],
      "WeightRange": {
        "C6": {
          "货币现金类": [0.0, 1.0],
          "固定收益类": [0.0, 1.0],
          "权益投资类": [0.0, 0.7]
        }
      },
      "StandardProportion": {
        "C6": {
          "货币现金类": 0.05,
          "固定收益类": 0.1,
          "权益投资类": 0.85
        }
      }
    }
    ```

*   **响应结果 (`出参`)**: 
    *   成功时，响应的 `data` 对象中将包含一个 `standard` 键。它是一个以标准组合名称（C1, C2, ...）为Key的对象，每个Key的值都遵循通用的结果结构：
        ```json
        "standard": {
          "C1": {
            "weights": [...],
            "ret_annual": [...],
            "risk_arr": [...],
            "ef_mask": [...]
          },
          "C2": { ... },
          ...
        }
        ```

### **3.3. 功能三：计算客户持仓组合**

*   **功能描述**: 根据客户的当前持仓、风险偏好和交易意愿，计算其专属的可配置空间与有效前沿。

*   **请求参数 (`入参`)**: 
    *   `asset_list` (Array[String], **必需**): 资产名称列表。
    *   `user_holding` (Object, **必需**): 封装所有与客户相关的约束信息。
        *   `WeightRange` (Object): 客户风险等级(C1~C6)对应的权重上下限。 `资产名称: [最小权重, 最大权重]`。
        *   `StandardProportion` (Object): 客户**当前的实际持仓比例**。 `资产名称: 权重`。
        *   `can_sell` (Object): 各大类资产**是否允许卖出**的布尔标记。`true`表示允许卖出（权重可低于当前值），`false`表示不允许（权重须不低于当前值）。
        *   `can_buy` (Object): 各大类资产**是否允许买入**的布尔标记。`true`表示允许买入（权重可高于当前值），`false`表示不允许（权重须不高于当前值）。
    *   **请求示例**:
    ```json
    {
      "asset_list": ["货币现金类", "固定收益类", "权益投资类"],
      "user_holding": {
        "WeightRange": {
          "货币现金类": [0.0, 1.0],
          "固定收益类": [0.0, 1.0],
          "权益投资类": [0.0, 0.7]
        },
        "StandardProportion": {
          "货币现金类": 0.1,
          "固定收益类": 0.5,
          "权益投资类": 0.4
        },
        "can_sell": {
          "货币现金类": false,
          "固定收益类": true,
          "权益投资类": true
        },
        "can_buy": {
          "货币现金类": true,
          "固定收益类": true,
          "权益投资类": false
        }
      }
    }
    ```

*   **响应结果 (`出参`)**: 
    *   成功时，响应的 `data` 对象中将包含一个 `user` 键，其值的结构与 **3.1** 中 `market` 键的结构完全相同，包含了客户专属的 `weights`, `ret_annual`, `risk_arr`, `ef_mask`。

---

## **4. 调用逻辑说明**

本API支持在单次请求中**组合调用**上述任意多个功能模块。API会根据请求体中存在的Key来决定执行哪些计算任务。

*   **例如**: 如果一个请求体中同时包含了 `cal_market_ef: true` 和 `user_holding: {...}`，那么成功的响应体中的 `data` 对象将会同时包含 `market` 和 `user` 两个键。

---

## **5. 错误码说明**

| Error Code                 | 含义                       | 建议处理方式                                         |
| -------------------------- | -------------------------- | ---------------------------------------------------- |
| `INVALID_JSON_INPUT`       | 请求体不是一个合法的JSON   | 检查请求体JSON语法是否正确。                         |
| `MISSING_OR_INVALID_FIELD` | 缺少必需字段或字段类型错误 | 对照文档检查 `asset_list` 等必需字段是否存在且格式正确。 |
| `DATA_FILE_NOT_FOUND`      | 服务器端依赖的数据文件缺失 | 这是一个服务器端问题，请联系Python服务维护人员。     |
| `INVALID_DATA_OR_CONFIG`   | 输入的业务数据或配置不合法 | 检查Excel数据或传入的约束值是否有效（例如，权重和不为1）。 |
| `INTERNAL_SERVER_ERROR`    | 服务器内部未知计算错误     | 这是一个通用的服务器端错误，请联系Python服务维护人员。 |